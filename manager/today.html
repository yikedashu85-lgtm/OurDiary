<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä»Šå¤©çš„äº‹ Â· OurDiary</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #f5f7f4;
}

header {
  height: 56px;
  background: #5b7052;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,.15);
}

header .title { font-weight: 600; font-size: 1rem; }
header .buttons button {
  margin-left: 8px;
  background: #fff;
  color: #5b7052;
  border: none;
  padding: 6px 12px;
  border-radius: 16px;
  cursor: pointer;
  font-size: 13px;
}

/* æ—¥è®°å¡ç‰‡å®¹å™¨ */
#diary-feed {
  max-width: 800px;
  margin: 16px auto;
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  padding: 0 16px;
}

/* æ—¥è®°å¡ç‰‡ */
.diary-card {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.diary-card .author {
  font-weight: 600;
  color: #5b7052;
  margin-bottom: 6px;
}

.diary-card .date {
  font-size: 0.8rem;
  color: #666;
  margin-bottom: 8px;
}

.diary-card .content {
  line-height: 1.6;
  white-space: pre-wrap;
}

/* å“åº”å¼ï¼šå°å±å¹•è‡ªåŠ¨å¡«å…… */
@media (max-width: 600px) {
  #diary-feed { padding: 0 8px; }
  .diary-card { padding: 12px; }
}
</style>
</head>
<body>

<header>
  <div class="title">ä»Šå¤©çš„äº‹</div>
  <div class="buttons">
    <button onclick="window.location.href='index.html'">âœï¸ å†™æ—¥è®°</button>
    <button onclick="window.location.href='library.html'">ğŸ“š æ—¥è®°åº“</button>
  </div>
</header>

<div id="diary-feed"></div>

<script>
const TOKEN_STORAGE_KEY = 'github_token';
const owner = "yikedashu85-lgtm";
const repo = "OurDiary";

// è·å–ä¿å­˜çš„ token
function getToken() {
  return localStorage.getItem(TOKEN_STORAGE_KEY);
}

// åŠ å¯†/è§£å¯†å·¥å…·å‡½æ•°
function deriveKeyFromToken(token) {
  const hash = CryptoJS.SHA256(token + 'OurDiarySalt2024');
  return hash;
}

function decryptContent(encryptedContent, keyHash) {
  try {
    const iv = CryptoJS.enc.Hex.parse('00000000000000000000000000000000');
    const decrypted = CryptoJS.AES.decrypt(encryptedContent, keyHash, {
      iv: iv,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });
    const result = decrypted.toString(CryptoJS.enc.Utf8);
    if (!result) {
      throw new Error('è§£å¯†å¤±è´¥');
    }
    return result;
  } catch(e) {
    throw new Error('è§£å¯†å¤±è´¥');
  }
}

// è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸² yyyy-mm-dd
function todayStr() {
  return new Date().toISOString().slice(0,10);
}

// ä» GitHub åŠ è½½ä»Šå¤©çš„æ—¥è®°
async function loadTodayDiaries() {
  const token = getToken();
  if (!token) {
    document.getElementById('diary-feed').innerHTML = '<p style="text-align:center;color:#666;">è¯·å…ˆè®¾ç½® GitHub Token</p>';
    return;
  }

  const feed = document.getElementById('diary-feed');
  feed.innerHTML = '<p style="text-align:center;color:#666;">æ­£åœ¨åŠ è½½...</p>';

  try {
    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/posts`, {
      headers: { Authorization: `token ${token}` }
    });

    if (!response.ok) {
      throw new Error('æ— æ³•è®¿é—® GitHub ä»“åº“');
    }

    const files = await response.json();
    const today = todayStr();
    const todayFiles = files.filter(f => f.name.endsWith('.md') && f.name.startsWith(today));
    
    if (todayFiles.length === 0) {
      feed.innerHTML = '<p style="text-align:center;color:#666;">ä»Šå¤©è¿˜æ²¡æœ‰æ—¥è®°~</p>';
      return;
    }

    feed.innerHTML = '';
    const keyHash = deriveKeyFromToken(token);
    const entries = [];

    // è·å–æ‰€æœ‰ä»Šå¤©çš„æ–‡ä»¶å†…å®¹
    for (const file of todayFiles) {
      try {
        const fileResponse = await fetch(file.download_url, {
          headers: { Authorization: `token ${token}` }
        });
        const encryptedContent = await fileResponse.text();
        const decryptedContent = decryptContent(encryptedContent, keyHash);
        
        // è§£æ front matter
        const frontMatterMatch = decryptedContent.match(/^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/);
        if (frontMatterMatch) {
          const metadata = {};
          frontMatterMatch[1].split('\n').forEach(line => {
            const [key, ...valueParts] = line.split(':');
            if (key && valueParts.length > 0) {
              metadata[key.trim()] = valueParts.join(':').trim();
            }
          });
          
          entries.push({
            author: metadata.author || 'æœªçŸ¥',
            date: metadata.date || file.name,
            content: frontMatterMatch[2]
          });
        }
      } catch(e) {
        console.error(`æ— æ³•è§£å¯†æ–‡ä»¶ ${file.name}:`, e);
      }
    }

    // æŒ‰æ—¶é—´å€’åº
    entries.sort((a,b)=>new Date(b.date) - new Date(a.date));

    if(entries.length === 0) {
      feed.innerHTML = '<p style="text-align:center;color:#666;">ä»Šå¤©è¿˜æ²¡æœ‰æ—¥è®°~</p>';
      return;
    }

    entries.forEach(e=>{
      const card = document.createElement('div');
      card.className = 'diary-card';
      card.innerHTML = `
        <div class="author">${e.author}</div>
        <div class="date">${new Date(e.date).toLocaleTimeString()}</div>
        <div class="content">${marked.parse(e.content)}</div>
      `;
      feed.appendChild(card);
    });
  } catch(e) {
    feed.innerHTML = `<p style="text-align:center;color:#d32f2f;">åŠ è½½å¤±è´¥: ${e.message}</p>`;
  }
}

window.addEventListener('load', loadTodayDiaries);
</script>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.js"></script>
</body>
</html>
