<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä»Šå¤©çš„äº‹ Â· OurDiary</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #f5f7f4;
}

header {
  height: 56px;
  background: #5b7052;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,.15);
}

header .title { font-weight: 600; font-size: 1rem; }
header .buttons button {
  margin-left: 8px;
  background: #fff;
  color: #5b7052;
  border: none;
  padding: 6px 12px;
  border-radius: 16px;
  cursor: pointer;
  font-size: 13px;
}

/* æ—¥è®°å¡ç‰‡å®¹å™¨ */
#diary-feed {
  max-width: 800px;
  margin: 16px auto;
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  padding: 0 16px;
}

/* æ—¥è®°å¡ç‰‡ */
.diary-card {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 16px;
  transition: box-shadow 0.2s;
}

.diary-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.diary-card .author {
  font-weight: 600;
  color: #5b7052;
  font-size: 15px;
}

.diary-card .date {
  font-size: 0.75rem;
  color: #999;
}

.diary-card .title {
  font-size: 18px;
  font-weight: 600;
  color: #333;
  margin: 12px 0 8px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid #f0f0f0;
}
.diary-card .content {
  line-height: 1.8;
  color: #444;
  margin-top: 12px;
}
.diary-card .content p {
  margin: 8px 0;
}
.diary-card .content h1, .diary-card .content h2, .diary-card .content h3 {
  margin-top: 16px;
  margin-bottom: 8px;
  color: #333;
}
.diary-card .content img {
  max-width: 100%;
  border-radius: 8px;
  margin: 12px 0;
}

/* å“åº”å¼ï¼šå°å±å¹•è‡ªåŠ¨å¡«å…… */
@media (max-width: 600px) {
  #diary-feed { padding: 0 8px; }
  .diary-card { padding: 12px; }
}
</style>
</head>
<body>

<header>
  <div class="title">ä»Šå¤©çš„äº‹</div>
  <div class="buttons">
    <button onclick="refreshFeed()">ğŸ”„ åˆ·æ–°</button>
    <button onclick="window.location.href='index.html'">âœï¸ å†™æ—¥è®°</button>
    <button onclick="window.location.href='library.html'">ğŸ“š æ—¥è®°åº“</button>
  </div>
</header>

<div id="diary-feed"></div>

<script>
const TOKEN_STORAGE_KEY = 'github_token';
const owner = "yikedashu85-lgtm";
const repo = "OurDiary";

// è·å–ä¿å­˜çš„ token
function getToken() {
  return localStorage.getItem(TOKEN_STORAGE_KEY);
}

// åŠ å¯†/è§£å¯†å·¥å…·å‡½æ•°
function deriveKeyFromToken(token) {
  const hash = CryptoJS.SHA256(token + 'OurDiarySalt2024');
  return hash;
}

function decryptContent(encryptedContent, keyHash) {
  try {
    const iv = CryptoJS.enc.Hex.parse('00000000000000000000000000000000');
    const decrypted = CryptoJS.AES.decrypt(encryptedContent, keyHash, {
      iv: iv,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });
    const result = decrypted.toString(CryptoJS.enc.Utf8);
    if (!result) {
      throw new Error('è§£å¯†å¤±è´¥');
    }
    return result;
  } catch(e) {
    throw new Error('è§£å¯†å¤±è´¥');
  }
}

// è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸² yyyy-mm-ddï¼ˆä½¿ç”¨æœ¬åœ°æ—¶é—´ï¼‰
function todayStr() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// è·å–å½“å‰æ—¶é—´æ˜¾ç¤ºï¼ˆåŒ…å«æ—¶åŒºä¿¡æ¯ï¼‰
function getCurrentTimeDisplay() {
  const now = new Date();
  return now.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    timeZoneName: 'short'
  });
}

// ä» GitHub åŠ è½½ä»Šå¤©çš„æ—¥è®°
async function loadTodayDiaries() {
  const token = getToken();
  if (!token) {
    document.getElementById('diary-feed').innerHTML = '<p style="text-align:center;color:#666;">è¯·å…ˆè®¾ç½® GitHub Token</p>';
    return;
  }

  const feed = document.getElementById('diary-feed');
  const today = todayStr();
  feed.innerHTML = `<p style="text-align:center;color:#666;">æ­£åœ¨åŠ è½½ä»Šå¤©çš„æ—¥è®° (${today})...</p>`;

  try {
    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/posts`, {
      headers: { Authorization: `token ${token}` }
    });

    if (!response.ok) {
      throw new Error('æ— æ³•è®¿é—® GitHub ä»“åº“');
    }

    const files = await response.json();
    
    // æ›´ç²¾ç¡®çš„æ–‡ä»¶åŒ¹é…ï¼šä»¥ä»Šå¤©çš„æ—¥æœŸå¼€å¤´ï¼Œä»¥.mdç»“å°¾
    const todayFiles = files.filter(f => {
      const isMd = f.name.endsWith('.md');
      const startsWithToday = f.name.startsWith(today);
      return isMd && startsWithToday;
    });
    
    console.log(`ä»Šå¤©æ—¥æœŸ: ${today}, æ‰¾åˆ° ${todayFiles.length} ä¸ªä»Šå¤©çš„æ—¥è®°æ–‡ä»¶:`, todayFiles.map(f => f.name));
    
    if (todayFiles.length === 0) {
      feed.innerHTML = `
        <p style="text-align:center;color:#666;">
          ä»Šå¤© (${today}) è¿˜æ²¡æœ‰æ—¥è®°~<br>
          <small>å½“å‰æ—¶é—´: ${getCurrentTimeDisplay()}</small>
        </p>`;
      return;
    }

    feed.innerHTML = '';
    const keyHash = deriveKeyFromToken(token);
    const entries = [];

    // è·å–æ‰€æœ‰ä»Šå¤©çš„æ–‡ä»¶å†…å®¹
    for (const file of todayFiles) {
      try {
        const fileResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/posts/${file.name}`, {
          headers: { Authorization: `token ${token}` }
        });
        const fileData = await fileResponse.json();
        const encryptedContent = atob(fileData.content);
        // è§£ç Base64å†…å®¹ï¼ˆåŒ¹é…index.htmlçš„ç¼–ç æ–¹å¼ï¼‰
        const decodedContent = decodeURIComponent(escape(encryptedContent));
        const decryptedContent = decryptContent(decodedContent, keyHash);
        
        // è§£æ front matter
        const frontMatterMatch = decryptedContent.match(/^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/);
        if (frontMatterMatch) {
          const metadata = {};
          frontMatterMatch[1].split('\n').forEach(line => {
            const [key, ...valueParts] = line.split(':');
            if (key && valueParts.length > 0) {
              metadata[key.trim()] = valueParts.join(':').trim();
            }
          });
          
          entries.push({
            title: metadata.title || 'æ— æ ‡é¢˜',
            author: metadata.author || 'æœªçŸ¥',
            date: metadata.date || file.name,
            content: frontMatterMatch[2]
          });
        }
      } catch(e) {
        console.error(`æ— æ³•è§£å¯†æ–‡ä»¶ ${file.name}:`, e);
      }
    }

    // æŒ‰æ—¶é—´å€’åº
    entries.sort((a,b)=>new Date(b.date) - new Date(a.date));

    if(entries.length === 0) {
      feed.innerHTML = '<p style="text-align:center;color:#666;">ä»Šå¤©è¿˜æ²¡æœ‰æ—¥è®°~</p>';
      return;
    }

    entries.forEach(e=>{
      const card = document.createElement('div');
      card.className = 'diary-card';
      const dateObj = new Date(e.date);
      const timeStr = dateObj.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div class="author">${e.author}</div>
          <div class="date">${timeStr}</div>
        </div>
        <div class="title">${e.title}</div>
        <div class="content">${marked.parse(e.content)}</div>
      `;
      feed.appendChild(card);
    });
  } catch(e) {
    feed.innerHTML = `<p style="text-align:center;color:#d32f2f;">åŠ è½½å¤±è´¥: ${e.message}</p>`;
  }
}

window.addEventListener('load', loadTodayDiaries);

// æ·»åŠ åˆ·æ–°åŠŸèƒ½
function refreshFeed() {
  loadTodayDiaries();
}

// æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ—¥æœŸæ˜¯å¦å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°åˆ°æ–°çš„ä¸€å¤©
let lastDate = todayStr();
function checkDateChange() {
  const currentDate = todayStr();
  if (currentDate !== lastDate) {
    console.log(`æ—¥æœŸå·²ä» ${lastDate} å˜ä¸º ${currentDate}ï¼Œè‡ªåŠ¨åˆ·æ–°é¡µé¢`);
    lastDate = currentDate;
    loadTodayDiaries();
  }
}

// æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ—¥æœŸå˜åŒ–
setInterval(checkDateChange, 30000);

// æ¯5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡å†…å®¹ï¼ˆè·å–æ–°æ—¥è®°ï¼‰
setInterval(refreshFeed, 300000);
</script>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.js"></script>
</body>
</html>
